<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <title>Jogo de Adivinhar Números</title>
</head>
<body>
    <div class="content">
        <div id="status"></div>
        <div class="left">
            <div class="gameContent">
                <h1>Jogo de Adivinhar Números</h1>
                <div id="gameArea" style="display: none;">
                    <p id="gameInfo"></p>
                    <div class="gameControls">
                        <input type="number" id="guessInput" placeholder="Palpite" />
                        <button id="guessButton">Enviar Palpite</button>
                        <button id="restart">Voltar a Jogar</button>
                    </div>
                </div>
                <div id="messages"></div>
                <div id="controls">
                    <button id="createGame">Criar Jogo</button>
                    <p>OU</p>
                    <input type="text" id="gameIdInput" placeholder="ID do Jogo" />
                    <button id="joinGame">Entrar no Jogo</button>
                </div>
            </div>
        </div>
        <div class="right"></div>
    </div>


    <!-- As soon as the page opens it directly connects -->
    <script>
        let clientId = null;
        let gameId = null;
        let ws = new WebSocket('ws://localhost:9090');  

        ws.onmessage = message => {
            const response = JSON.parse(message.data);
            console.log('Recebido do servidor:', response);

            if (response.method === 'connect') {
                clientId = response.clientId;
                //console.log("Client id set successfully" + clientId);
                document.getElementById('status').innerText += `O teu ID\n${clientId}`;
            } else if (response.method === 'create') {
                gameId = response.game.id;
                document.getElementById('gameInfo').innerText = `Jogo criado com ID\n${gameId}`;
                document.getElementById('gameArea').style.display = 'block';
                const msg = response.game.msg;
                addMessage(msg);
            } else if (response.method === 'join') {
                gameId = response.game.id;
                document.getElementById('gameInfo').innerText = `Entraste no jogo ${gameId}.`;
                document.getElementById('gameArea').style.display = 'block';
                const msg = response.game.msg;
                addMessage(msg);
            } else if (response.method === 'updatePlayers') {
                const msg = response.msg;
                addMessage(msg);
            } else if (response.method === 'hint') {
                addMessage(response.msg);
            } else if (response.method === 'result') {
                addMessage(response.msg);
                document.getElementById("restart").style.display = "block";
                document.getElementById("messages").style.maxHeight = "190px";
                document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
            } else if (response.method === 'error') {
                document.getElementById("controls").style.display = "flex";
                addMessage('Erro: ' + response.message);
            }
        };

        ws.onerror = error => {
            console.error('WebSocket error:', error);
        };

        document.getElementById('createGame').addEventListener('click', () => {
            const payLoad = {
                method: 'create',
                clientId: clientId
            };
            document.getElementById("controls").style.display = "none";
            ws.send(JSON.stringify(payLoad));
        });

        document.getElementById('joinGame').addEventListener('click', () => {
            const joinGameId = document.getElementById('gameIdInput').value;
            if (joinGameId === '') {
                alert('Insere um ID de jogo para entrar');
                return;
            }
            const payLoad = {
                method: 'join',
                clientId: clientId,
                gameId: joinGameId
            };
            document.getElementById("controls").style.display = "none";
            ws.send(JSON.stringify(payLoad));
        });

        document.getElementById('guessButton').addEventListener('click', () => {
            sendGuess();
        });

        document.getElementById('guessInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter'){
                sendGuess();
            }
        });

        function sendGuess(){
            const guess = parseInt(document.getElementById('guessInput').value, 10);
            if (isNaN(guess)){
                alert("Insere um número válido");
                return;
            }
            
            const payLoad = {
                method: "guess",
                clientId: clientId,
                gameId: gameId,
                number: guess
            };
            ws.send(JSON.stringify(payLoad));
            document.getElementById("guessInput").value = ''; // clears the line
        }

        document.getElementById('restart').addEventListener('click', () => {
            document.getElementById("gameArea").style.display = "none";
            document.getElementById("controls").style.display = "flex";
            document.getElementById("messages").innerHTML = "";
            document.getElementById("messages").style.maxHeight = "250px";
        });

        function addMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const newMsg = document.createElement('p');
            newMsg.innerText = msg;
            messagesDiv.appendChild(newMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

    </script>
</body>
</html>